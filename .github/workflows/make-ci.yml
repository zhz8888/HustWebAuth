name: CI Build

on:
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests
      run: go test -v ./...

    - name: Build artifacts
      id: build
      run: |
        echo "Starting build process..."
        
        # Create output directory
        mkdir -p output
        
        # Build for current platform
        go build -o output/hustwebauth-${{ runner.os }} .
        
        # For Linux, also build using cross-compilation Makefile
        if [ "${{ runner.os }}" = "Linux" ]; then
          make -f Makefile.cross-compiles
          # Move cross-compiled binaries to output directory
          find release -type f -executable -exec cp {} output/ \;
        fi
        
        echo "Build process completed successfully"
        
        # List build artifacts for verification
        echo "Generated artifacts:"
        ls -la output/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hustwebauth-${{ runner.os }}
        path: output/
        retention-days: 30

  cross-compile:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: Download dependencies
      run: go mod download

    - name: Cross-compile for all platforms
      run: |
        echo "Starting cross-compilation..."
        make -f Makefile.cross-compiles
        echo "Cross-compilation completed successfully"
        
        # List cross-compiled artifacts
        echo "Generated artifacts:"
        ls -la output/

    - name: Upload cross-compiled artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hustwebauth-cross-platform
        path: output/
        retention-days: 30