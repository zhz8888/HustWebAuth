name: CI Build

on:
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests
      run: go test -v ./...

    - name: Cross-compile for all platforms
      run: |
        echo "Starting cross-compilation..."
        make -f Makefile.cross-compiles
        echo "Cross-compilation completed successfully"
        
        # List cross-compiled artifacts
        echo "Generated artifacts:"
        ls -la output/

    - name: Upload cross-compiled artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HustWebAuth-cross-platform
        path: output/
        retention-days: 30
